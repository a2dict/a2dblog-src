---
title: 微服务设计总结
date: 2020-03-26 13:18:49
tags: [编程, 架构]
---

做了不少微服务化重构工作，这里贴贴总结吧。

<!-- more -->

# 不要过早微服务化

是的！就像不应该过早优化，你不应该过早微服务化！！

开发早期，对系统认识受限。随着开发进行，领域知识增加，对系统理解更加深刻，架构趋于稳定。
企图开发初期做出「完美设计」，并合理地拆分服务是很不现实的。

微服务增加了系统复杂度，不合理的服务拆分只会导致更大的维护和修正成本！！

应该在系统架构趋于成熟时才考虑微服务化，属于增加系统复杂度换其它质量属性——伸缩性、容错性...

当然，也不排除你是「领域专家」，可以提前做好服务规划。但就算这种情形，我也建议**不要过早微服务化**。

# 演进式微服务化

一般项目早期，最合适的设计是单体。
在早期开发过程中，应该为可能未来微服务化拆分提前做好准备。
虽然物理上不拆分服务，但代码上应该进行逻辑拆分。

比如，一个商店系统，可以拆分成「订单服务」、「商品服务」、「购物车」、「用户服务」...，并且只允许通过服务通信访问对应数据。

一种很糟糕的设计是不同「服务」（逻辑上或物理上）共享数据层，这会导致数据耦合；整个系统很难进行数据层调整，难以维护。
「服务」应该屏蔽实现细节，提供语义抽象。服务间只允许通过**语义化接口**相互访问，不管它到底是用python+mongo还是go+mysql实现。

这也是微服务的一个很重要的好处——异构服务。可以根据具体场景应用更合适的技术栈。

# 不要DBService!!
我看过不少系统，在DB之上运行一个DBService，为其它服务提供存储能力。
有些系统甚至直接用Spring Data Rest之类的工具，将DB操作以REST接口方式直接对外暴露。

这是一种很糟糕的设计！！
1) 它本质上还是一种「共享数据架构模式」，会导致数据耦合
2) DBService是一个贫血服务，接口与DBScheme强绑定。它无法提供「操作数据」能力抽象。这样的服务完全没意义，是多余的
3) 我遇到过由于DBService阻塞而导致整个系统不可用情况。引入DBService无法使系统更可靠，反而更脆弱了

# 按业务拆分，而不是按功能拆分（单一职责原则）
微服务的一个常见的滥用是，按功能进行拆分。比如上面的DBService就是这么一个例子。
有些微服务实践直接按单体的层级、服务结构进行拆分，这是不合理的
1) 这种方式只是把单体应用放到了云平台上去，架构毫无变化。除了增加网络延迟和维护难度外毫无用处
2) 当需求变更时，需要改动的服务有多少？——所有

微服务架构设计应该符合「单一职责原则」—— 一个服务应该只有一个发生变化的原因。
更合理的拆分方式是按业务用例纵向拆分。这样的好处有
1) 需求变更导致的变化限制在单个或少数服务中
2) 服务提供业务抽象，服务间解耦，方便不同团队独立开发、维护


To Be Continued ..

推荐书籍：
- 微服务设计